# 담보대출 계산기 프로젝트 요약

## 📋 프로젝트 개요

텔레그램 봇을 통해 담보물건 정보를 입력받아 여러 금융사의 주택담보대출 한도와 금리를 자동으로 계산하는 시스템입니다.

## 🏗️ 아키텍처

```
텔레그램 메시지 → 파서 → 계산 엔진 → 금융사별 계산기 → 결과 포맷터 → 텔레그램 응답
```

## 📁 주요 파일 구조

### 핵심 모듈

1. **`main.py`**: 텔레그램 봇 메인 진입점 (로컬 실행용)
2. **`api/webhook.py`**: Vercel 서버리스 함수 (배포용)

### 파서 모듈 (`parsers/`)

- **`message_parser.py`**: 텔레그램 메시지를 구조화된 데이터로 변환
  - 성명, 연령, 직업, 신용점수 추출
  - 주소에서 지역 추출
  - 근저당권 설정 내역 파싱
  - ⚠️ **TODO**: 대환 여부 판단 로직 추가 필요 (207번째 줄 주석 참고)

### 계산기 모듈 (`calculator/`)

- **`base_calculator.py`**: 금융사 계산기 클래스
  - 개별 금융사 계산 로직 (LTV, 한도, 금리)
  - 지역별 급지 조회
  - 신용등급별 금리 조회
  - JSON 파일 경로 또는 딕셔너리로 초기화 가능
  - `calculate_all_banks()` 클래스 메서드로 모든 금융사 계산
  - data/banks 폴더의 JSON 파일 자동 로드
  - 새 금융사 추가 시 JSON 파일만 추가하면 자동 등록

### 유틸리티 모듈 (`utils/`)

- **`validators.py`**: 데이터 검증
  - KB시세 검증 (없으면 None 반환)
  - 신용점수 검증
  - 금액 파싱

- **`formatter.py`**: 결과 포맷팅
  - 통합된 형식: `* BNK캐피탈 (4등급기준)\n후순위 74% 43,900만 / 6.65%`
  - 신용점수 없을 때 금리 범위 표시
  - 대환인 경우 전체 금액과 가용한도 구분 표시

### 설정 파일 (`data/`)

- **`banks/bnk_config.json`**: BNK캐피탈 조건 설정
  - 금융사별 모든 정보를 한 파일에 관리
  - 지역별 급지 (`region_grades`): 구/시/군 단위로 세밀하게 설정 가능
    - 구/시/군 단위 매핑이 있으면 우선 사용
    - 없으면 광역 단위(서울, 경기 등)로 자동 fallback
  - 급지별 최대 LTV (`max_ltv_by_grade`)
  - LTV별 신용등급별 금리 (`interest_rates_by_ltv`)
  - 신용점수→등급 매핑 (`credit_score_to_grade`)
  - 특이 조건 (`conditions`)
  - 수동으로 수정 가능

## 🔧 주요 기능

### ✅ 구현 완료

1. ✅ 텔레그램 메시지 파싱
2. ✅ KB시세 검증 (없으면 산출 불가)
3. ✅ 신용점수 없을 때 금리 범위 표시
4. ✅ 지역별 급지 매핑 (구/시/군 단위 지원)
5. ✅ LTV별 한도 계산
6. ✅ 신용등급별 금리 적용
7. ✅ 결과 포맷팅 (통합 형식)
8. ✅ 금융사 추가/편집 가능한 구조 (JSON 파일만 추가)

### ⚠️ TODO (추후 구현)

1. **대환 여부 판단 로직**
   - 위치: `parsers/message_parser.py` 207번째 줄
   - 메시지에서 "대환" 키워드 또는 패턴으로 판단
   - 계산 시 대환/후순위 구분

2. **선순위/후순위 판단 로직**
   - 근저당권 설정 내역 기반으로 판단

3. **다른 금융사 추가**
   - `data/banks/새금융사_config.json` 파일만 추가하면 자동 등록
   - Python 클래스 작성 불필요

## 🚀 실행 방법

### 로컬 실행

```bash
cd mortgage_calculator
pip install -r requirements.txt

# config/telegram_config.py에 토큰 설정
python main.py
```

### Vercel 배포

1. GitHub에 프로젝트 업로드
2. Vercel에 연결
3. 환경 변수 설정: `TELEGRAM_BOT_TOKEN`
4. Webhook URL을 텔레그램에 등록

## 📝 설정 파일 수정 가이드

### 새로운 금융사 추가

1. `data/banks/새금융사_config.json` 파일 생성 (BNK 설정 참고)
   - 금융사별 모든 정보(급지, 금리, 조건 등)를 한 파일에 작성
   - 파일만 추가하면 자동으로 계산기에 등록됨

### 기존 금융사 조건 수정

`data/banks/` 폴더의 해당 JSON 파일을 직접 수정하면 됩니다.

## 🔍 인코딩

모든 파일은 **UTF-8** 인코딩을 사용합니다.
파일 상단에 `# -*- coding: utf-8 -*-` 주석이 포함되어 있습니다.

## 📊 계산 로직

1. **KB시세 검증**: 없으면 산출 불가 (None 반환)
2. **지역 확인**: 주소에서 행정구역 추출 (구/시/군 단위) → 급지 확인
   - 구/시/군 단위 매핑이 있으면 우선 사용
   - 없으면 광역 단위로 fallback
3. **최대 LTV 확인**: 급지별 최대 LTV 확인
4. **기존 근저당권 계산**: 1순위, 2순위 등 총액 계산
5. **LTV별 한도 계산**: 
   - `가용한도 = (KB시세 × LTV%) - 기존 근저당권 총액`
   - 대환인 경우: 전체 금액과 가용한도 구분
6. **금리 조회**: 
   - 신용점수 있으면: 해당 등급 금리
   - 신용점수 없으면: 최저~최고 금리 범위

## 🎯 결과 형식

### 기본 형식
```
* BNK캐피탈 (4등급기준)
후순위 74% 43,900만 / 6.65%
후순위 70% 40,400만 / 6.20%~10.70%
- 사업자 등록된 3개월 이상 개인사업자
```

### 대환인 경우
```
* BNK캐피탈 (4등급기준)
대환 80% 49,300만 / 가용 20,000만 / 7.60%
```

### 신용점수 없을 때
```
* BNK캐피탈
후순위 70% 40,400만 / 6.20%~10.70%
```

## ⚙️ 환경 변수

- `TELEGRAM_BOT_TOKEN`: 텔레그램 봇 API 토큰 (필수)

## 📚 참고 문서

- `README.md`: 프로젝트 기본 정보
- `USAGE.md`: 상세 사용 가이드
- `PROJECT_SUMMARY.md`: 이 문서

